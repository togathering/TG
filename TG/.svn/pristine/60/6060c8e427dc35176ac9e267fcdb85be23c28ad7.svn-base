package com.tg.friend.control;

import java.util.ArrayList;

import javax.servlet.http.HttpSession;

import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.stereotype.Controller;
import org.springframework.ui.Model;
import org.springframework.web.bind.annotation.RequestMapping;
import org.springframework.web.bind.annotation.RequestParam;

import com.tg.common.beans.FriendBean;
import com.tg.common.beans.MemberBean;
import com.tg.common.dao.FriendDAO;
import com.tg.common.dao.MemberDAO;

@Controller
public class FriendControl {
	
	@Autowired
	FriendBean fbean;
	@Autowired
	FriendDAO fdao;
	@Autowired
	MemberDAO mdao;
	
	@RequestMapping("/addFriend")
	public String addFriend(Model model, 
			@RequestParam(value="search", required=false)String search, 
			@RequestParam(value="friend", required=false)String fid,
			HttpSession session){

		String id = session.getAttribute("id").toString();
		
		fbean.setId(id);
		fbean.setFid(fid);
		
		if(fdao.addFriend(fbean)){
			System.out.println("친추성공");
		}else{
			System.out.println("친추실패");
		}
		return "redirect:searchuser?search="+search;
	}
	
	@RequestMapping("/myFriendReq")
	public String friendReq(HttpSession session, Model model){
		String id = (String) session.getAttribute("id");
		
		ArrayList<FriendBean> list = (ArrayList<FriendBean>) fdao.friendRequestList(id);
		ArrayList<MemberBean> freq = new ArrayList<MemberBean>();
		for(int i=0;i<list.size();i++){
			String reqId = list.get(i).getId();
			if(!fdao.friendCheck(id, reqId)){				
				freq.add(mdao.selectMem(reqId));
				
			}
		}		
		model.addAttribute("freq", freq);
		
		return "user/mypage/friendReq";
	}
	
	@RequestMapping("/myFriendList")
	public String friendList(HttpSession session, Model model, 
			@RequestParam(value="page", required=false)String reqPage,
			@RequestParam(value="gno", required=false)Integer gno){		
		String rePage = "";
		
		String id = session.getAttribute("id").toString();
			
		ArrayList<FriendBean> list = (ArrayList<FriendBean>) fdao.friendRequestList(id);
		ArrayList<MemberBean> flist = new ArrayList<MemberBean>();
		for(int i=0;i<list.size();i++){
			String reqId = list.get(i).getId();
			if(fdao.friendCheck(id, reqId)){
				flist.add(mdao.selectMem(reqId));				
			
			}
		}			
		model.addAttribute("flist", flist);
		if(reqPage.equals("myPage")){
			rePage= "user/mypage/friendList";
		}else if(reqPage.equals("invite")){
			model.addAttribute("gno", gno);
			rePage= "user/mypage/inviteList";
		}
		
		return rePage;
	}
	
	@RequestMapping("/acceptFriend")
	public String acceptFriend(HttpSession session, @RequestParam(value="acceptId")String acceptId){
		
		String id = (String) session.getAttribute("id");

		fbean.setId(id);
		fbean.setFid(acceptId);
		
		fdao.addFriend(fbean);

		return "redirect:myFriend";
	}
	
	@RequestMapping("/rejectFriend")
	public String refectFriend(@RequestParam(value="rejectId")String rejectId){
		
		fdao.delRequest(rejectId);		

		return "redirect:myFriend";
	}
}
